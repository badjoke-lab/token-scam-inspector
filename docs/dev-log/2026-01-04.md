
## Task 14 でできるようになること（完了後・ざっくり）

* ブラウザ上で **chain と address を入力**できる
* ボタンを押すと **`/api/inspect` を呼ぶ**（Workers API連携が始まる）
* 返ってきたJSONを **暫定表示（そのまま）**できる（まず動く状態）

---

## ✅ タスク文ここから

```md
# Task 14 — UI: Input + Call /api/inspect + Show Raw JSON (Phase 1 / Stage 5)

## PR title rule (MUST)
Set the PR title to:
- **Task 14: UI input + inspect call (raw JSON)**

## Goal
Build the first functional UI:
- Input form for `chain` and `address`
- Call `/api/inspect`
- Display the returned JSON in a simple raw format (pre/code block)
No styling beyond minimal readability.

## Source of truth (MUST FOLLOW)
- Specs: `docs/specs/**`（ui-spec-ja.md / spec-phase1-ja.md）
- Ops rules: `AGENTS.md`, `codex/**`
- Common rules: `codex/tasks/task-00-rules.md`

## Allowed changes
- May add/update: `app/**`, `README.md` (minimal if needed)
- Must NOT edit: `docs/specs/**`
- Must NOT change workers in this task（UIだけ）

## Hard constraints (MUST)
- No UI beautification（カード/影/アニメ/凝ったレイアウト禁止）
- No verdict/scoring/investment advice wording
- Mobile-safe（横スクロールなし）
- Keep it simple: 1 page only

---

## UI requirements

### 1) Update `app/index.html`
Add a simple form:
- `chain` input (text or select)
  - Default: `eth`
  - Allow at least: `eth`, `bsc`
- `address` input (text)
- A button: "Inspect" (or similar neutral label)
- A small note:
  - "This tool shows risk signals with explanations. Not a verdict."
  - "No investment advice."

Add a result area:
- Status line (idle/loading/success/error)
- Raw JSON display:
  - `<pre><code id="result"></code></pre>`

### 2) Implement logic in `app/app.js`
- On submit:
  - Read chain + address
  - Build request URL:
    - Prefer GET query: `/api/inspect?chain=...&address=...`
    - (If current API expects POST, follow existing worker implementation — but do not change workers in this task.)
  - Show loading state
  - Fetch and parse JSON
  - Render JSON as pretty-printed text:
    - `JSON.stringify(data, null, 2)`
- Error handling:
  - Network error -> show neutral message
  - Non-200 -> still try to parse JSON, show it
- Prevent double-submit while loading

### 3) Minimal CSS update (`app/style.css`)
Only minimal readability:
- Inputs full width on mobile
- Button spacing
- `<pre>` scrollable horizontally ONLY inside pre if needed (page must not overflow)
- Keep existing simple styles; do not add fancy design

### 4) No extra features
- No history
- No sample tokens list
- No auto-validate beyond simple trimming/lowercasing
- No additional pages

## Acceptance checklist
- [ ] UI has chain + address inputs and an Inspect button
- [ ] Clicking Inspect calls `/api/inspect` and shows returned JSON
- [ ] Loading/error states are visible
- [ ] Mobile-safe (no horizontal scroll on the page)
- [ ] No workers changes in this task
- [ ] No edits to `docs/specs/**`
```

## ✅ タスク文ここまで

https://6df6b77b.token-scam-inspector.pages.dev/



エラー発生で１４−１
状況は把握した。**今の `pages.dev/api/inspect` は Workers のJSONじゃなく、PagesのHTML（= UIページ）を返してる**。
だから UI 側は「JSONとして読めないHTML」を掴んで壊れる（前のスクショの通り）。今回のスクショで `/api/inspect?...` を開いて **UIが出てる**のがその証拠。

**結論：俺が決める。**
このまま **pages.dev 配下で `/api/*` をWorkersにルーティングするのは基本ムリ**（pages.devは自分のドメインじゃないので Workers Routes を切れない）。
なので **UIを `workers.dev` 側の `/api/inspect` に向ける**。そのために **Task 14 の枝番で修正**する。

---

## Task 14-1 でできるようになること（完了後・ざっくり）

* 入力して「Inspect」を押すと、**本物の `/api/inspect`（Workers）**を叩けるようになる
* 返ってきた **JSONがそのままRaw JSONに表示**される（HTML混入が消える）
* **CORS対応**が入り、Pages（UI）→ Workers（API）の通信が通る

---

## ✅ タスク文ここから

````md
# Task 14-1 — Fix UI → Workers API wiring (CORS) (Phase 1 / Stage 5)

## PR title rule (MUST)
Set the PR title to:
- **Task 14-1: Wire UI to Workers /api/inspect (CORS)**

## Goal
Fix the current broken behavior where `/api/inspect` on `*.pages.dev` returns HTML (Pages) instead of JSON (Workers).
Make the UI call the Workers deployment directly and ensure CORS allows the request.

## Why this is needed (context)
- On `pages.dev`, `/api/inspect` is NOT routed to Workers; it falls back to the Pages HTML.
- Result: UI receives HTML and JSON parse fails.
- Fix: UI must call the Workers endpoint (workers.dev) and Workers must allow CORS.

## Source of truth (MUST FOLLOW)
- Specs: `docs/specs/**`
- Ops rules: `AGENTS.md`, `codex/**`
- Common rules: `codex/tasks/task-00-rules.md`

## Allowed changes
- May add/update: `app/**`, `workers/**`, `README.md` (minimal if needed)
- Must NOT edit: `docs/specs/**`

---

## Requirements

### 1) Add configurable API base URL (UI)
Update `app/app.js` (or `app/index.html`) to use an API base URL.

Rules:
- Default to same-origin first: `""`
- If same-origin `/api/inspect` responds with HTML (or non-JSON), fallback to `WORKERS_API_BASE`.
- `WORKERS_API_BASE` must be configurable via a simple constant at top of `app/app.js`:

Example:
```js
const WORKERS_API_BASE = "https://REPLACE_ME.workers.dev"; // user will replace
````

Behavior:

* Primary attempt: `fetch("/api/inspect?...")`
* If response `Content-Type` does NOT include `application/json`, then:

  * retry once using `${WORKERS_API_BASE}/api/inspect?...`
* If `WORKERS_API_BASE` is still the placeholder, show a neutral message:

  * “API route is not connected on pages.dev. Set WORKERS_API_BASE to your deployed workers.dev URL.”

### 2) Add CORS support in Workers

Update `workers/src/index.ts`:

* For `/api/inspect` (and `/api/hello` is fine too), ensure responses include:

  * `Access-Control-Allow-Origin: *` (simple and OK for Phase 1)
  * `Access-Control-Allow-Methods: GET, OPTIONS`
  * `Access-Control-Allow-Headers: Content-Type`
* Handle preflight:

  * `OPTIONS /api/inspect` returns 204 with the above CORS headers.

### 3) Keep everything neutral

* No verdict/scoring/investment advice text added.
* No new features. Only wiring/CORS.

---

## Acceptance checklist

* [ ] UI Inspect works on `https://token-scam-inspector.pages.dev/` without “invalid JSON” errors
* [ ] Raw JSON displays actual JSON from `/api/inspect`
* [ ] `/api/inspect` on pages.dev may still show HTML (known limitation), but UI uses Workers fallback correctly
* [ ] Workers responses include CORS headers
* [ ] OPTIONS preflight returns 204 with CORS headers
* [ ] No edits to `docs/specs/**`

```

## ✅ タスク文ここまで

---

### 補足（お前がやることは1つだけ）
PRができたら、`WORKERS_API_BASE` の `REPLACE_ME` を **自分の workers.dev のURLに置換**すれば即動く。  
（これを自動推測するのは事故るので、固定で1箇所だけ手で入れる設計にする）

::contentReference[oaicite:0]{index=0}
```

https://github.com/badjoke-lab/token-scam-inspector/pull/17

https://6e68a188.token-scam-inspector.pages.dev/

https://b571da2c.token-scam-inspector.pages.dev/

アドレスを入力するとjsonが表示されるようになりました




いい。**完全に動いてる**。

* `Inspection complete.` が出てる＝フロント→Workers 呼び出し成功
* JSON の `ok: true`＝APIが正常応答
* `meta.cached: true`＝**キャッシュHIT**（同じ入力を再度叩いた結果が使い回されてる）
* いま `unknown` が多いのは **ExplorerのAPIキー未設定で「取得できない」扱い**になってるから（想定どおり）

次はスケジュール通り **Task 15（結果サマリ + checks一覧）** に進む。

---

## Task 15 でできるようになること（完了後）

* Raw JSONだけじゃなく、**人が読める形で結果の要点**（overall / summary / top reasons）が見える
* **checks一覧が「ラベル・結果・短い説明」**で並び、必要なら詳細も開ける
* **cache HIT/MISS** が画面上で分かる（headerとmetaを表示）

---

## ✅ タスク文ここから

```md
# Task 15 — UI: Summary + Checks List (Phase 1 / Step 15)

## PR title rule (MUST)
Set the PR title to:
- **Task 15: UI summary and checks list**

## Goal
Improve the Pages UI so that `/api/inspect` results are readable:
- show a small summary (overallRisk/summary/topReasons)
- show a checks list (label/result/short + optional details)
Keep styling minimal (no cards/shadows/animations).

## Source of truth (MUST FOLLOW)
- Specs: `docs/specs/**`
- Ops rules: `AGENTS.md`, `codex/**`
- Common rules: `codex/tasks/task-00-rules.md`

## Allowed changes
- May add/update: `app/**` only
- Must NOT edit: `docs/specs/**`

## Requirements

### 1) UI structure in `app/index.html`
Add sections below the form:

- A "Summary" section containing:
  - Overall risk (string)
  - Summary text
  - Top reasons (list; empty state if none)
  - Cache status (HIT/MISS if available, otherwise unknown)

- A "Checks" section containing:
  - A list of checks:
    - label
    - result (unknown/low/medium/high or ok; display as text only)
    - short
    - details (optional; use `<details><summary>…</summary>…</details>`)

Keep existing "Raw JSON" section, but move it to the bottom.

### 2) Render logic in `app/app.js`
After receiving JSON:
- If `data.ok !== true`, show an error summary and keep raw JSON.
- If ok:
  - Fill Summary from:
    - `data.result.overallRisk`
    - `data.result.summary`
    - `data.result.topReasons` (array)
  - Fill Checks from `data.checks` (array)
    - For each check:
      - label, result, short
      - If `detail`, show in details
      - If `evidence` array exists, render as `<ul>`
      - If `howToVerify` array exists, render as `<ul>`
  - Cache indicator:
    - Read `x-tsi-cache` response header (HIT/MISS) if present
    - Also show `data.meta.cached` as a boolean
    - Display as: `Cache: HIT (meta.cached=true)` etc.

Important:
- Do NOT introduce verdict language ("scam", "safe", etc.)
- Keep everything neutral and explainable.

### 3) Minimal CSS in `app/style.css`
- Keep it simple: spacing, readable headings, list spacing.
- No fancy components.

## Acceptance checklist
- [ ] Inspect result shows Summary (overallRisk/summary/topReasons)
- [ ] Checks list shows label/result/short for all items
- [ ] Details show evidence/howToVerify when present
- [ ] Raw JSON still visible
- [ ] Cache status visible (header or meta)
- [ ] No edits to `docs/specs/**`
```

## ✅ タスク文ここまで

```

---

### 補足（いまの状態での“正常/異常”の見分け方）
- **正常**：`ok:true` が出る／SummaryとChecksが埋まる（次のTask 15で整形される）
- **正常**：`meta.cached:true` になる（同条件で2回目以降に出やすい）
- **異常**：HTMLが返ってくる（＝Pages側の /api/inspect を叩いてしまってる）→今はWORKERS_API_BASEで回避できてるからOK

このまま Task 15 を回して、マージしたら **画面が「ツールっぽく」読める状態**になる。
::contentReference[oaicite:0]{index=0}
```

https://github.com/badjoke-lab/token-scam-inspector/pull/18

https://424e50e2.token-scam-inspector.pages.dev/


了解しました。まず **「PR番号」と「Task番号」は別物**です。

* **PR #18** は「このリポジトリで作られた18個目のPR」というだけ（過去に失敗したPRや、別ブランチのPRもカウントされる）
* **Task XX** はあなたの進行管理用の番号
  → だから **PR番号をTaskと揃えるのは無理**。代わりに「PRタイトル先頭を `Task XX:` にする」で運用固定が正解。

で、あなたはいま **Task 15 までマージ済み**なので、次はスケジュール通り **Task 16（UI詳細表示）**です。

---

## 次にやる：Task 16（UI 詳細表示）

### Task 16 でできるようになること（完了後）

* **checks一覧を“人間が読める形”で表示**（label / result / short）
* 各チェックを開くと **detail / evidence / howToVerify が見れる**（折りたたみでOK）
* **unknown / エラー / ローディング**がUIで破綻しない（いまのRaw JSONだけより「使える」）

---

## ✅ タスク文ここから

```md
# Task 16 — UI Detail View for Checks (Phase 1 / Stage 5)

## PR title rule (MUST)
Set the PR title to:
- **Task 16: UI check details view**

## Goal
Improve the Pages UI so users can read the inspection result without reading Raw JSON.
Show overall + topReasons + checks list, and provide per-check detail (detail/evidence/howToVerify).
Handle unknown/error/loading states cleanly.

## Source of truth (MUST FOLLOW)
- Specs: `docs/specs/**`
- UI spec: `docs/specs/ui-spec-ja.md`
- Common rules: `AGENTS.md`, `codex/tasks/task-00-rules.md`

## Allowed changes
- May add/update: `app/index.html`, `app/app.js`, `app/style.css`
- Must NOT edit: `docs/specs/**`
- Must NOT change Workers behavior in this task

## Requirements

### 1) Add a "Result" section above Raw JSON
In `app/index.html`, add a section like:

- Overall Risk (text + small badge)
- Summary (text)
- Top reasons (bulleted list; empty-state text if none)
- Cached indicator (based on `meta.cached` boolean)

Keep existing "Raw JSON" section.

### 2) Render checks list (human-readable)
In `app/app.js`, after receiving JSON:
- If `data.ok !== true`:
  - Show an error box with `data.error.message` (fallback to generic)
  - Still render Raw JSON
- If `data.ok === true`:
  - Render checks as a list:
    - label
    - result badge (ok/warn/high/unknown)
    - short
  - Each check item must be expandable (use `<details><summary>` or a simple click toggle)

Expanded content must show:
- detail (paragraph)
- evidence (ul; show "No evidence" if empty)
- howToVerify (ol or ul; show "No steps" if empty)

### 3) Loading / error state
- While fetching: show "Inspecting..." and disable inputs (already present; keep)
- On network error: show a clear message + keep Raw JSON as `{ error: ... }`
- On 400 (bad address): show message near the form (already shown via status line; keep)

### 4) Minimal styling (mobile first)
In `app/style.css`:
- Add simple badges for ok/warn/high/unknown (no fancy colors required; can be grayscale)
- Ensure long lines wrap (addresses, evidence URLs)
- checks list should not overflow on mobile

### 5) Acceptance checklist
- [ ] Overall / Summary / Top reasons are visible without reading Raw JSON
- [ ] checks list shows label + result + short
- [ ] Each check can be expanded to show detail/evidence/howToVerify
- [ ] Handles ok:false responses (shows error message)
- [ ] Loading/disabled behavior still works
- [ ] Raw JSON section remains
- [ ] No changes to `docs/specs/**` and no Workers changes

```

## ✅ タスク文ここまで

---

### 補足（いま「入力したら動くのか？」の答え）

動きます。いまの挙動はこうです：

* **適当な文字列** → Workersが **400 bad_request** を返す → UIで「status 400」「Invalid address format」が出る（正常）
* **0xで始まる42文字のアドレス**（例：あなたの `0x0000...0000`）→ `ok:true` の結果が返る → UIで表示される（正常）

ただ、現状は「Raw JSONを読むしかない」ので、**Task 16で“読めるUI”に仕上げる**のが次です。

https://github.com/badjoke-lab/token-scam-inspector/pull/19

https://a63fba37.token-scam-inspector.pages.dev/


承知しました。PR #19 をマージ＝ **Task 16 完了**でOKです。
これで **Stage 5（UI）まで完了**、残りは **Task 17 → Task 18** の2つだけ。

---

## ✅ Phase 1 確定版タスクスケジュール（現在地つき）

### 完了済み

* **Task 01**：Skeleton UI + 最小構造
* **Task 02**：Workers土台 + `/api/hello`
* **Task 03**：`/api/inspect` 骨格（ダミー＋バリデーション＋エラー形式）
* **Task 04**：Cache API（TTL 24h + stale/失敗方針含む）
* **Task 05**：Explorer接続（ETH/BSC 最小データ取得の土台）
* **Task 06**：判定項目①
* **Task 07**：判定項目②
* **Task 08**：判定項目③
* **Task 09**：判定項目④
* **Task 10**：判定項目⑤
* **Task 11**：判定項目⑥
* **Task 12**：判定項目⑦
* **Task 13**：overall / topReasons 組み立て
* **Task 14**：UI 入力フォーム＋呼び出し＋Raw JSON表示
* **Task 15**：UI 結果サマリ＋checks一覧
* **Task 16**：UI 詳細表示（why/evidence/how-to-verify）＋unknown/エラー/ローディング
  ✅ **いまここ（最新）**

### 残り

* **Task 17**：最小保護（レート制限/免責/文言最終チェック）
* **Task 18**：本番確認 + 仕上げ（最終動作確認）

---

# 次に進める：Task 17

### Task 17 でできるようになること（完了後）

* 連打や悪用で落ちにくくなる（**最小のレート制限**）
* 事故りやすい表現を最後に一掃（**禁止ワード/投資助言の最終チェック**）
* 公開運用に必要な「最低限の注意書き」が揃う（**免責の固定**）

---

## ✅ タスク文ここから

```md
# Task 17 — Minimal Protection + Disclaimer Final Check (Phase 1 / Stage 6)

## PR title rule (MUST)
Set the PR title to:
- **Task 17: minimal protection + disclaimer**

## Goal
Add minimal protection so the public endpoint is harder to abuse on free tier,
and ensure final wording stays neutral (no verdict, no investment advice).

## Source of truth (MUST FOLLOW)
- Specs: `docs/specs/**`
- Ops rules: `AGENTS.md`, `codex/**`
- Common rules: `codex/tasks/task-00-rules.md`

## Allowed changes
- May add/update: `workers/**`, `app/**` (text only if needed), `README.md` (minimal)
- Must NOT edit: `docs/specs/**`

## Requirements

### 1) Add minimal rate limiting (soft)
Implement a very small, non-invasive guard in the Worker for `/api/inspect`.

Rules:
- Identify client by IP signal (Cloudflare header) + endpoint path
  - Use `request.headers.get("CF-Connecting-IP")` if present, else "unknown"
- Keep an in-memory style limiter using Cloudflare cache as a counter key
  - Key example: `__rl__/inspect?ip=<ip>&window=60`
- Window: 60 seconds
- Allow: 10 requests per minute per IP (simple threshold)
- If exceeded:
  - Return JSON 429 with the existing neutral error shape:
    - code: `rate_limited`
    - message: `Too many requests. Please try again later.`
  - Add `Retry-After: 60` header
- Do NOT block other endpoints like `/api/hello`

Notes:
- This is "best effort" on free tier. It does not need to be perfect.
- Must remain neutral language (no verdict, no advice).
- Must not add any new infra (KV/D1/R2/etc.)

### 2) Add final wording safety check (UI text only)
Quick scan and fix any wording in UI strings that might imply:
- verdict ("scam", "safe", "fraud")
- investment advice ("buy/sell", "should invest")

If any found, replace with allowed neutral wording.

### 3) Acceptance checklist
- [ ] `/api/inspect` returns 429 JSON when exceeded
- [ ] `Retry-After` header is present on 429
- [ ] Normal traffic still works (under limit)
- [ ] No new infra added (KV/D1/R2/etc.)
- [ ] UI/Worker text stays neutral (no verdict, no investment advice)
- [ ] No edits to `docs/specs/**`

```

## ✅ タスク文ここまで

```

---

これが終わったら **Task 18（最終動作確認＋仕上げ）**で Phase 1 完了。
::contentReference[oaicite:0]{index=0}
```

https://github.com/badjoke-lab/token-scam-inspector/pull/20

https://bd06441e.token-scam-inspector.pages.dev/


了解。**Task 17 マージ＝Stage 6 完了**。
残りは **Task 18（最終動作確認＋仕上げ）だけ**。これが通れば **Phase 1 完了**。

---

## Task 18 でできるようになること（完了後）

* 「本番でちゃんと動く」ことを**チェックリストで証明**できる（URL付きで残せる）
* 想定外の挙動（JSON崩れ、CORS、キャッシュ、429、文言事故）を**全部潰した状態で公開**できる
* Phase 1 を「完成」として**堂々と開発ログに固定**できる

---

## ✅ タスク文ここから

```md
# Task 18 — Production Verification + Final Polish (Phase 1 / Stage 7)

## PR title rule (MUST)
Set the PR title to:
- **Task 18: production verification**

## Goal
Do final production verification for both:
- Cloudflare Pages UI
- Cloudflare Workers API

Fix only “release-blocker” issues found during verification.
No new features.

## Source of truth (MUST FOLLOW)
- Specs: `docs/specs/**`
- Ops rules: `AGENTS.md`, `codex/**`
- Common rules: `codex/tasks/task-00-rules.md`

## Allowed changes
- May add/update: `app/**`, `workers/**`, `README.md` (minimal)
- Must NOT edit: `docs/specs/**`

---

## Verification checklist (MUST DO)

### A) URLs to verify (fill in actual URLs)
- Pages (prod): https://token-scam-inspector.pages.dev/
- Workers (prod): <YOUR_WORKERS_DEV_URL>
  - /api/hello
  - /api/inspect?chain=eth&address=0x0000000000000000000000000000000000000000
  - /api/inspect?chain=bsc&address=0x0000000000000000000000000000000000000000

### B) API behavior
1) **JSON only**
- /api/hello returns JSON
- /api/inspect returns JSON (200/400/429 all JSON)

2) **Validation**
- bad chain -> 400 with { ok:false, error:{code,message}, meta:{...} }
- bad address -> 400 with same shape

3) **Cache**
- Call same /api/inspect twice:
  - second call should indicate cache HIT somehow (header or meta)
- Confirm `meta.cached` flips logically (or document the chosen behavior)

4) **Rate limit**
- Hit /api/inspect repeatedly to exceed threshold:
  - returns 429 JSON
  - Retry-After header exists

5) **Missing API key safe behavior**
- If explorer key is missing:
  - output remains neutral
  - checks stay “unknown” with evidence explaining “missing_api_key”
  - no crash / no HTML error page

### C) UI behavior (Pages)
1) UI loads and form works on mobile width (no horizontal scroll).
2) Pressing Inspect:
- shows loading state
- shows “complete” or “status xxx”
- Raw JSON renders readable

3) UI must call the correct API:
- If UI uses WORKERS_API_BASE constant:
  - confirm it matches the deployed workers.dev URL
  - do NOT leave placeholder text
- Ensure UI does not accidentally call `/api/inspect` on pages.dev and parse HTML.

4) Wording safety sweep (must be strict)
- No verdict words (“scam/safe/fraud” etc.)
- No investment advice (“buy/sell/should invest” etc.)
If found anywhere, replace with neutral wording.

### D) Capture proof (minimal)
In PR description, paste:
- Pages URL
- Workers URL
- 2–3 example API URLs that you tested
- Brief “Result: PASS” notes (one line each)

---

## Allowed fixes (only if needed)
- Fix wrong endpoint base URL in UI
- Fix JSON parsing / content-type check
- Fix any route returning HTML
- Fix wording violations
- Minor CSS spacing only if it affects mobile scroll/readability
DO NOT add new features or redesign.

---

## Acceptance checklist
- [ ] All verification checklist items PASS
- [ ] UI uses the correct API endpoint (no HTML parsed)
- [ ] Cache + rate-limit behavior verified
- [ ] Wording is neutral and compliant
- [ ] PR description includes proof URLs and PASS notes
- [ ] No edits to `docs/specs/**`

```

## ✅ タスク文ここまで

```

---

これで **Task 18 がマージされたら Phase 1 完了**。次は Phase 2（必要なら）に移れる状態。
::contentReference[oaicite:0]{index=0}
```

https://github.com/badjoke-lab/token-scam-inspector/pull/21

https://b8505978.token-scam-inspector.pages.dev/



