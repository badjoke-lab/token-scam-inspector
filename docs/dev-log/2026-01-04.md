
## Task 14 でできるようになること（完了後・ざっくり）

* ブラウザ上で **chain と address を入力**できる
* ボタンを押すと **`/api/inspect` を呼ぶ**（Workers API連携が始まる）
* 返ってきたJSONを **暫定表示（そのまま）**できる（まず動く状態）

---

## ✅ タスク文ここから

```md
# Task 14 — UI: Input + Call /api/inspect + Show Raw JSON (Phase 1 / Stage 5)

## PR title rule (MUST)
Set the PR title to:
- **Task 14: UI input + inspect call (raw JSON)**

## Goal
Build the first functional UI:
- Input form for `chain` and `address`
- Call `/api/inspect`
- Display the returned JSON in a simple raw format (pre/code block)
No styling beyond minimal readability.

## Source of truth (MUST FOLLOW)
- Specs: `docs/specs/**`（ui-spec-ja.md / spec-phase1-ja.md）
- Ops rules: `AGENTS.md`, `codex/**`
- Common rules: `codex/tasks/task-00-rules.md`

## Allowed changes
- May add/update: `app/**`, `README.md` (minimal if needed)
- Must NOT edit: `docs/specs/**`
- Must NOT change workers in this task（UIだけ）

## Hard constraints (MUST)
- No UI beautification（カード/影/アニメ/凝ったレイアウト禁止）
- No verdict/scoring/investment advice wording
- Mobile-safe（横スクロールなし）
- Keep it simple: 1 page only

---

## UI requirements

### 1) Update `app/index.html`
Add a simple form:
- `chain` input (text or select)
  - Default: `eth`
  - Allow at least: `eth`, `bsc`
- `address` input (text)
- A button: "Inspect" (or similar neutral label)
- A small note:
  - "This tool shows risk signals with explanations. Not a verdict."
  - "No investment advice."

Add a result area:
- Status line (idle/loading/success/error)
- Raw JSON display:
  - `<pre><code id="result"></code></pre>`

### 2) Implement logic in `app/app.js`
- On submit:
  - Read chain + address
  - Build request URL:
    - Prefer GET query: `/api/inspect?chain=...&address=...`
    - (If current API expects POST, follow existing worker implementation — but do not change workers in this task.)
  - Show loading state
  - Fetch and parse JSON
  - Render JSON as pretty-printed text:
    - `JSON.stringify(data, null, 2)`
- Error handling:
  - Network error -> show neutral message
  - Non-200 -> still try to parse JSON, show it
- Prevent double-submit while loading

### 3) Minimal CSS update (`app/style.css`)
Only minimal readability:
- Inputs full width on mobile
- Button spacing
- `<pre>` scrollable horizontally ONLY inside pre if needed (page must not overflow)
- Keep existing simple styles; do not add fancy design

### 4) No extra features
- No history
- No sample tokens list
- No auto-validate beyond simple trimming/lowercasing
- No additional pages

## Acceptance checklist
- [ ] UI has chain + address inputs and an Inspect button
- [ ] Clicking Inspect calls `/api/inspect` and shows returned JSON
- [ ] Loading/error states are visible
- [ ] Mobile-safe (no horizontal scroll on the page)
- [ ] No workers changes in this task
- [ ] No edits to `docs/specs/**`
```

## ✅ タスク文ここまで

https://6df6b77b.token-scam-inspector.pages.dev/



エラー発生で１４−１
状況は把握した。**今の `pages.dev/api/inspect` は Workers のJSONじゃなく、PagesのHTML（= UIページ）を返してる**。
だから UI 側は「JSONとして読めないHTML」を掴んで壊れる（前のスクショの通り）。今回のスクショで `/api/inspect?...` を開いて **UIが出てる**のがその証拠。

**結論：俺が決める。**
このまま **pages.dev 配下で `/api/*` をWorkersにルーティングするのは基本ムリ**（pages.devは自分のドメインじゃないので Workers Routes を切れない）。
なので **UIを `workers.dev` 側の `/api/inspect` に向ける**。そのために **Task 14 の枝番で修正**する。

---

## Task 14-1 でできるようになること（完了後・ざっくり）

* 入力して「Inspect」を押すと、**本物の `/api/inspect`（Workers）**を叩けるようになる
* 返ってきた **JSONがそのままRaw JSONに表示**される（HTML混入が消える）
* **CORS対応**が入り、Pages（UI）→ Workers（API）の通信が通る

---

## ✅ タスク文ここから

````md
# Task 14-1 — Fix UI → Workers API wiring (CORS) (Phase 1 / Stage 5)

## PR title rule (MUST)
Set the PR title to:
- **Task 14-1: Wire UI to Workers /api/inspect (CORS)**

## Goal
Fix the current broken behavior where `/api/inspect` on `*.pages.dev` returns HTML (Pages) instead of JSON (Workers).
Make the UI call the Workers deployment directly and ensure CORS allows the request.

## Why this is needed (context)
- On `pages.dev`, `/api/inspect` is NOT routed to Workers; it falls back to the Pages HTML.
- Result: UI receives HTML and JSON parse fails.
- Fix: UI must call the Workers endpoint (workers.dev) and Workers must allow CORS.

## Source of truth (MUST FOLLOW)
- Specs: `docs/specs/**`
- Ops rules: `AGENTS.md`, `codex/**`
- Common rules: `codex/tasks/task-00-rules.md`

## Allowed changes
- May add/update: `app/**`, `workers/**`, `README.md` (minimal if needed)
- Must NOT edit: `docs/specs/**`

---

## Requirements

### 1) Add configurable API base URL (UI)
Update `app/app.js` (or `app/index.html`) to use an API base URL.

Rules:
- Default to same-origin first: `""`
- If same-origin `/api/inspect` responds with HTML (or non-JSON), fallback to `WORKERS_API_BASE`.
- `WORKERS_API_BASE` must be configurable via a simple constant at top of `app/app.js`:

Example:
```js
const WORKERS_API_BASE = "https://REPLACE_ME.workers.dev"; // user will replace
````

Behavior:

* Primary attempt: `fetch("/api/inspect?...")`
* If response `Content-Type` does NOT include `application/json`, then:

  * retry once using `${WORKERS_API_BASE}/api/inspect?...`
* If `WORKERS_API_BASE` is still the placeholder, show a neutral message:

  * “API route is not connected on pages.dev. Set WORKERS_API_BASE to your deployed workers.dev URL.”

### 2) Add CORS support in Workers

Update `workers/src/index.ts`:

* For `/api/inspect` (and `/api/hello` is fine too), ensure responses include:

  * `Access-Control-Allow-Origin: *` (simple and OK for Phase 1)
  * `Access-Control-Allow-Methods: GET, OPTIONS`
  * `Access-Control-Allow-Headers: Content-Type`
* Handle preflight:

  * `OPTIONS /api/inspect` returns 204 with the above CORS headers.

### 3) Keep everything neutral

* No verdict/scoring/investment advice text added.
* No new features. Only wiring/CORS.

---

## Acceptance checklist

* [ ] UI Inspect works on `https://token-scam-inspector.pages.dev/` without “invalid JSON” errors
* [ ] Raw JSON displays actual JSON from `/api/inspect`
* [ ] `/api/inspect` on pages.dev may still show HTML (known limitation), but UI uses Workers fallback correctly
* [ ] Workers responses include CORS headers
* [ ] OPTIONS preflight returns 204 with CORS headers
* [ ] No edits to `docs/specs/**`

```

## ✅ タスク文ここまで

---

### 補足（お前がやることは1つだけ）
PRができたら、`WORKERS_API_BASE` の `REPLACE_ME` を **自分の workers.dev のURLに置換**すれば即動く。  
（これを自動推測するのは事故るので、固定で1箇所だけ手で入れる設計にする）

::contentReference[oaicite:0]{index=0}
```

https://github.com/badjoke-lab/token-scam-inspector/pull/17

https://6e68a188.token-scam-inspector.pages.dev/

https://b571da2c.token-scam-inspector.pages.dev/

アドレスを入力するとjsonが表示されるようになりました




いい。**完全に動いてる**。

* `Inspection complete.` が出てる＝フロント→Workers 呼び出し成功
* JSON の `ok: true`＝APIが正常応答
* `meta.cached: true`＝**キャッシュHIT**（同じ入力を再度叩いた結果が使い回されてる）
* いま `unknown` が多いのは **ExplorerのAPIキー未設定で「取得できない」扱い**になってるから（想定どおり）

次はスケジュール通り **Task 15（結果サマリ + checks一覧）** に進む。

---

## Task 15 でできるようになること（完了後）

* Raw JSONだけじゃなく、**人が読める形で結果の要点**（overall / summary / top reasons）が見える
* **checks一覧が「ラベル・結果・短い説明」**で並び、必要なら詳細も開ける
* **cache HIT/MISS** が画面上で分かる（headerとmetaを表示）

---

## ✅ タスク文ここから

```md
# Task 15 — UI: Summary + Checks List (Phase 1 / Step 15)

## PR title rule (MUST)
Set the PR title to:
- **Task 15: UI summary and checks list**

## Goal
Improve the Pages UI so that `/api/inspect` results are readable:
- show a small summary (overallRisk/summary/topReasons)
- show a checks list (label/result/short + optional details)
Keep styling minimal (no cards/shadows/animations).

## Source of truth (MUST FOLLOW)
- Specs: `docs/specs/**`
- Ops rules: `AGENTS.md`, `codex/**`
- Common rules: `codex/tasks/task-00-rules.md`

## Allowed changes
- May add/update: `app/**` only
- Must NOT edit: `docs/specs/**`

## Requirements

### 1) UI structure in `app/index.html`
Add sections below the form:

- A "Summary" section containing:
  - Overall risk (string)
  - Summary text
  - Top reasons (list; empty state if none)
  - Cache status (HIT/MISS if available, otherwise unknown)

- A "Checks" section containing:
  - A list of checks:
    - label
    - result (unknown/low/medium/high or ok; display as text only)
    - short
    - details (optional; use `<details><summary>…</summary>…</details>`)

Keep existing "Raw JSON" section, but move it to the bottom.

### 2) Render logic in `app/app.js`
After receiving JSON:
- If `data.ok !== true`, show an error summary and keep raw JSON.
- If ok:
  - Fill Summary from:
    - `data.result.overallRisk`
    - `data.result.summary`
    - `data.result.topReasons` (array)
  - Fill Checks from `data.checks` (array)
    - For each check:
      - label, result, short
      - If `detail`, show in details
      - If `evidence` array exists, render as `<ul>`
      - If `howToVerify` array exists, render as `<ul>`
  - Cache indicator:
    - Read `x-tsi-cache` response header (HIT/MISS) if present
    - Also show `data.meta.cached` as a boolean
    - Display as: `Cache: HIT (meta.cached=true)` etc.

Important:
- Do NOT introduce verdict language ("scam", "safe", etc.)
- Keep everything neutral and explainable.

### 3) Minimal CSS in `app/style.css`
- Keep it simple: spacing, readable headings, list spacing.
- No fancy components.

## Acceptance checklist
- [ ] Inspect result shows Summary (overallRisk/summary/topReasons)
- [ ] Checks list shows label/result/short for all items
- [ ] Details show evidence/howToVerify when present
- [ ] Raw JSON still visible
- [ ] Cache status visible (header or meta)
- [ ] No edits to `docs/specs/**`
```

## ✅ タスク文ここまで

```

---

### 補足（いまの状態での“正常/異常”の見分け方）
- **正常**：`ok:true` が出る／SummaryとChecksが埋まる（次のTask 15で整形される）
- **正常**：`meta.cached:true` になる（同条件で2回目以降に出やすい）
- **異常**：HTMLが返ってくる（＝Pages側の /api/inspect を叩いてしまってる）→今はWORKERS_API_BASEで回避できてるからOK

このまま Task 15 を回して、マージしたら **画面が「ツールっぽく」読める状態**になる。
::contentReference[oaicite:0]{index=0}
```

https://github.com/badjoke-lab/token-scam-inspector/pull/18

https://424e50e2.token-scam-inspector.pages.dev/


了解しました。まず **「PR番号」と「Task番号」は別物**です。

* **PR #18** は「このリポジトリで作られた18個目のPR」というだけ（過去に失敗したPRや、別ブランチのPRもカウントされる）
* **Task XX** はあなたの進行管理用の番号
  → だから **PR番号をTaskと揃えるのは無理**。代わりに「PRタイトル先頭を `Task XX:` にする」で運用固定が正解。

で、あなたはいま **Task 15 までマージ済み**なので、次はスケジュール通り **Task 16（UI詳細表示）**です。

---

## 次にやる：Task 16（UI 詳細表示）

### Task 16 でできるようになること（完了後）

* **checks一覧を“人間が読める形”で表示**（label / result / short）
* 各チェックを開くと **detail / evidence / howToVerify が見れる**（折りたたみでOK）
* **unknown / エラー / ローディング**がUIで破綻しない（いまのRaw JSONだけより「使える」）

---

## ✅ タスク文ここから

```md
# Task 16 — UI Detail View for Checks (Phase 1 / Stage 5)

## PR title rule (MUST)
Set the PR title to:
- **Task 16: UI check details view**

## Goal
Improve the Pages UI so users can read the inspection result without reading Raw JSON.
Show overall + topReasons + checks list, and provide per-check detail (detail/evidence/howToVerify).
Handle unknown/error/loading states cleanly.

## Source of truth (MUST FOLLOW)
- Specs: `docs/specs/**`
- UI spec: `docs/specs/ui-spec-ja.md`
- Common rules: `AGENTS.md`, `codex/tasks/task-00-rules.md`

## Allowed changes
- May add/update: `app/index.html`, `app/app.js`, `app/style.css`
- Must NOT edit: `docs/specs/**`
- Must NOT change Workers behavior in this task

## Requirements

### 1) Add a "Result" section above Raw JSON
In `app/index.html`, add a section like:

- Overall Risk (text + small badge)
- Summary (text)
- Top reasons (bulleted list; empty-state text if none)
- Cached indicator (based on `meta.cached` boolean)

Keep existing "Raw JSON" section.

### 2) Render checks list (human-readable)
In `app/app.js`, after receiving JSON:
- If `data.ok !== true`:
  - Show an error box with `data.error.message` (fallback to generic)
  - Still render Raw JSON
- If `data.ok === true`:
  - Render checks as a list:
    - label
    - result badge (ok/warn/high/unknown)
    - short
  - Each check item must be expandable (use `<details><summary>` or a simple click toggle)

Expanded content must show:
- detail (paragraph)
- evidence (ul; show "No evidence" if empty)
- howToVerify (ol or ul; show "No steps" if empty)

### 3) Loading / error state
- While fetching: show "Inspecting..." and disable inputs (already present; keep)
- On network error: show a clear message + keep Raw JSON as `{ error: ... }`
- On 400 (bad address): show message near the form (already shown via status line; keep)

### 4) Minimal styling (mobile first)
In `app/style.css`:
- Add simple badges for ok/warn/high/unknown (no fancy colors required; can be grayscale)
- Ensure long lines wrap (addresses, evidence URLs)
- checks list should not overflow on mobile

### 5) Acceptance checklist
- [ ] Overall / Summary / Top reasons are visible without reading Raw JSON
- [ ] checks list shows label + result + short
- [ ] Each check can be expanded to show detail/evidence/howToVerify
- [ ] Handles ok:false responses (shows error message)
- [ ] Loading/disabled behavior still works
- [ ] Raw JSON section remains
- [ ] No changes to `docs/specs/**` and no Workers changes

```

## ✅ タスク文ここまで

---

### 補足（いま「入力したら動くのか？」の答え）

動きます。いまの挙動はこうです：

* **適当な文字列** → Workersが **400 bad_request** を返す → UIで「status 400」「Invalid address format」が出る（正常）
* **0xで始まる42文字のアドレス**（例：あなたの `0x0000...0000`）→ `ok:true` の結果が返る → UIで表示される（正常）

ただ、現状は「Raw JSONを読むしかない」ので、**Task 16で“読めるUI”に仕上げる**のが次です。

https://github.com/badjoke-lab/token-scam-inspector/pull/19

https://3caf8756.token-scam-inspector.pages.dev/





