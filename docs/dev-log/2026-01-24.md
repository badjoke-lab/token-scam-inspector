了解。**Task 19 は「Phase 2 docs は既にある前提」で、“内容監査→漏れ補足→整合修正” のタスク**として出し直す。

---

## Task 19 でできるようになること（完了後）

* 既存の Phase 2 docs（spec/roadmap）が **要件漏れなく**揃い、以降の Task 20〜28 が **迷わず参照できる “唯一の根拠”** になる
* docs 内の **成功条件 / 非目標 / UX読み順 / エラー / キャッシュ(stale) / 共有URL / 静的ページ / i18n / smoke** が **矛盾なく**明文化される
* `docs/specs/index.md` が（存在するなら）更新され、Phase 1 / Phase 2 の参照が迷子にならない

```md
✅ タスク文ここから

# Task 19 — Phase 2 Docs: audit + patch (spec/roadmap already exists)

## PR title rule (MUST)
PR title must start with:
- **Task 19: Phase 2 docs audit+patch**

## Context
Phase 2 docs are already uploaded under `docs/` (no new creation needed by default).
This task is to REVIEW them against requirements and PATCH missing/unclear parts.

## Goal
Make Phase 2 docs complete and consistent so Tasks 20–28 can reference them without ambiguity.

## Source of truth (MUST FOLLOW)
- Phase 1 docs:
  - `docs/specs/spec-phase1-ja.md`
  - `docs/specs/roadmap-phase1-ja.md`
  - `docs/specs/task-schedule-phase1-ja.md`
  - `docs/specs/ui-spec-ja.md`
- Existing Phase 2 docs (already present in repo):
  - `docs/specs/spec-phase2-ja.md` (or equivalent)
  - `docs/specs/roadmap-phase2-ja.md` (or equivalent)
- Ops rules: `AGENTS.md`, `codex/**`, `codex/tasks/task-00-rules.md`

## Allowed changes
- Update: existing Phase 2 docs under `docs/specs/` (filenames must NOT be needlessly renamed)
- Update: `docs/specs/index.md` (IF it exists; add links)
- Must NOT break/overwrite Phase 1 docs
- Must NOT change API implementation in this task (docs-only)

## What to do (WORK ITEMS)
### 1) Inventory (must write in PR description)
- List all Phase 2 doc files found in `docs/specs/` and their roles.
- If filenames differ from the plan, keep them but note mapping:
  - spec → which file
  - roadmap → which file

### 2) Spec audit checklist (patch missing items)
Ensure `spec-phase2-ja.md` includes (or clearly references) ALL below.
If any are missing/weak, ADD/PATCH them:

A. Success conditions (minimum bar)
- “Phase 2 done” criteria in bullet form
- Explicitly: beginner-first UI order, shareable URL, human-readable errors, stale rules, fewer unknowns, guide/dictionary pages

B. Scope + Non-goals
- Scope: chains, inputs, outputs
- Non-goals: no scam断定, no investment advice, no paid infra requirement, no all-chain support

C. API response compatibility rules
- Must not break Phase 1 response shape
- Allowed additions:
  - `meta.stale` (stale return)
  - `result.token` (identity best-effort)
  - header `x-tsi-cache: HIT|MISS|STALE`

D. UX behavior requirements (beginner-first reading order)
- Order: overall/summary/topReasons → checks list → details/evidence/howToVerify → raw JSON hidden
- “unknown means not confirmed (not safe)” note
- mobile-first (360px) requirement

E. Data sources + limits
- Explorer sources, RPC best-effort for token identity
- Rate limit handling: show reasons, do not hide failures

F. Cache + stale behavior (MUST be explicit)
- TTL rules (24h baseline)
- stale return priority rules:
  - fresh success → fresh
  - upstream fail + stale exists → stale (`meta.stale=true`, header STALE)
  - upstream fail + stale none → ok:false error JSON

G. Error taxonomy (MUST be explicit)
- Define stable error codes to be used in Task 22:
  - `missing_api_key`, `rate_limited`, `upstream_error`, `invalid_response`
  - (plus input errors like invalid_chain/address)
- Must always return JSON (no HTML)

H. Explainability rules for 7 checks
- Reduce false positives (comments/strings best-effort removal) as Task 23 goal
- Evidence must state what signal was detected (not “Found pattern” only)
- Avoid single weak signal => high

I. Static pages requirements
- Guide page + 7 dictionary pages (meaning/why/howToVerify) as Task 26

J. i18n and ops verification
- Simple dictionary-based JA/EN toggle as Task 27
- Smoke check script + README ops notes as Task 28

### 3) Roadmap audit checklist (patch missing items)
Ensure `roadmap-phase2-ja.md` includes:
- Task 19–28 mapping (10 tasks) with:
  - Goal / Work items / Done criteria
- Explicit dependencies:
  - Task 19 is docs-only
  - Task 20 uses current API without changing it
  - Task 22 adds meta/header (non-breaking)
- “What is NOT included in Phase 2” note aligned with spec

### 4) Index link patch (only if file exists)
- If `docs/specs/index.md` exists:
  - Add links to Phase 2 spec/roadmap
  - Keep Phase 1 links intact

## Acceptance checklist
- [ ] Phase 2 spec/roadmap contain all required sections (no major omissions)
- [ ] Success conditions + non-goals are explicit and consistent
- [ ] Error/stale/cache rules are explicit and align with upcoming tasks
- [ ] Roadmap maps exactly Task 19–28 with Done criteria
- [ ] (If exists) specs index includes Phase 2 links
- [ ] No Phase 1 docs were modified (unless fixing a typo with explicit reason)

✅ タスク文ここまで
```

---

https://github.com/badjoke-lab/token-scam-inspector/pull/22

https://7413b3cb.token-scam-inspector.pages.dev/

---

## Task 20（改訂版）でできるようになること（完了後）

* **トップで“読める結果”**（Overall→理由→チェック一覧→詳細）が成立し、JSONは通常見えない
* **失敗/未入力/invalid/unknown/stale** のときでも、ユーザーが迷わず状況を理解できる
* 次タスク（21〜）が **このUI骨格の上に積める**（共有URL、辞書リンク、i18n等）


✅ タスク文ここから

# Task 20 — UI: beginner-first result rendering (no raw JSON by default)

## PR title rule (MUST)
PR title must start with:
- **Task 20: UI readable results**

## Target (MUST: directories/files)
Cloudflare Pages frontend only.
- `app/index.html`
- `app/style.css`
- `app/app.js`
(If these do not exist, use the actual current entry files under `app/` and list the mapping in PR description. No Workers changes.)

## Goal
Replace "raw JSON dump" with an explainable, beginner-first layout:
1) Overall block (risk badge + 1–2 line summary)
2) Top reasons (3–5 bullets)
3) Checks list (7 items) as compact rows
4) Per-check details (expandable) with evidence + howToVerify
5) Raw JSON only in a collapsed `<details>` at bottom

## Source of truth (MUST FOLLOW)
- `docs/specs/ui-spec-ja.md`
- `docs/specs/spec-phase1-ja.md`
- `docs/specs/spec-phase2-ja.md` (after Task 19)
- Ops rules: `AGENTS.md`, `codex/**`

## Hard constraints
- MUST NOT change Workers/API response shape in this task
- Mobile-first: 360px width must remain readable (no horizontal scroll)

## UI requirements (minimum)
### A) States (must be visible, not console-only)
- **Empty state**: before running inspect → short guide text + example input format
- **Loading state**: spinner/text + disable submit
- **Success state**: render in the required order (below)
- **Error state** (`ok:false` or fetch fail): show human message + error code (if present)
- **Unknown guidance**: always show a note near top:
  - “unknown = 確認できなかった（安全を意味しない）”
- **Cache/stale hint** (if meta exists): show small label:
  - cached / stale (best-effort; do not depend on it)

### B) Success rendering (field mapping)
- Overall block uses:
  - `result.overallRisk` (badge)
  - `result.summary` (1–2 lines)
- Top reasons:
  - `result.topReasons[]` as bullets (max 5, safe truncation)
- Checks list (compact rows):
  - each item shows: label + status badge + short (1 line)
  - badge styles: ok / warn / high / unknown
- Per-check details (expand/collapse):
  - show **detail** (human explanation)
  - show **evidence** (what was seen / why unknown)
  - show **howToVerify** (user action steps)
  - if a field is missing, hide that section (no “undefined”)

### C) Raw JSON placement rule
- Raw JSON must be placed ONLY under:
  - `<details><summary>Raw JSON</summary> ... </details>`
- Default collapsed.

### D) Basic accessibility/UX
- Buttons have clear labels
- Expand/collapse controls are tappable on mobile
- Long strings wrap (addresses, URLs, evidence text)

## Acceptance checklist
- [ ] Default view no longer shows raw JSON
- [ ] Success UI order is exactly: Overall → Reasons → Checks → Details → Raw JSON
- [ ] Empty/Loading/Error states are visible and understandable
- [ ] Works with current `/api/inspect` response (no Workers change)
- [ ] 360px mobile layout has no horizontal scroll

## Verification (manual)
- Test with:
  1) valid ETH address
  2) invalid address (should show human error)
  3) upstream failure scenario (simulate by changing WORKERS_API_BASE temporarily) → error UI shown
- Confirm raw JSON is collapsed by default.

✅ タスク文ここまで

https://github.com/badjoke-lab/token-scam-inspector/pull/23

https://b4a2aac6.token-scam-inspector.pages.dev/

---

## Task 21（改訂版）でできるようになること（完了後）

* URL（`?chain=&address=`）が **単一の真実（source of truth）** になり、貼った人/開いた人で **同じ検査が再現**できる
* 入力フォームとURLが同期し、**更新・再読込・戻る/進む**でも状態が崩れない
* 共有ボタンが **意図どおりのリンク**（余計なノイズなし）をコピーできる

✅ タスク文ここから

# Task 21 — UI: shareable deep link (URL as source-of-truth)

## PR title rule (MUST)
PR title must start with:
- **Task 21: Shareable URL**

## Target (MUST: directories/files)
Cloudflare Pages frontend only.
- `app/index.html`
- `app/app.js`
- `app/style.css` (only if needed for button/layout)
(No Workers changes.)

## Goal
Make inspect state fully reproducible from URL query params:
- Canonical form: `?chain=eth&address=0x...`
When valid params exist on load, auto-run inspection.
When user runs inspection from the form, update the URL (without reload).
Provide a "Copy share link" action that copies the canonical URL.

## Source of truth (MUST FOLLOW)
- `docs/specs/spec-phase2-ja.md` (Deep link rules)
- `docs/specs/ui-spec-ja.md`
- Ops rules: `AGENTS.md`, `codex/**`

## Hard constraints
- URL is the source of truth for "what was inspected".
- MUST NOT require page reload to update URL.
- MUST show invalid-param errors in the UI (not console-only).

## Requirements (behavior)
### A) Parse on load
- On `DOMContentLoaded`:
  - read `chain`, `address` from `location.search`
  - if both valid:
    - prefill the form inputs
    - auto-trigger inspect once
  - if one is missing or invalid:
    - do NOT auto-run
    - show a human-readable error ONLY if params are present (e.g. address invalid)
      - error must say what is wrong (invalid chain / invalid address)

### B) Sync URL on submit (no reload)
- When user clicks "Inspect" and input is valid:
  - update URL via `history.replaceState` (or pushState; choose one and justify in PR)
  - canonicalize:
    - `chain` lowercased
    - `address` checksummed optional, but at least lower/trim safe
  - keep existing unrelated params OPTIONAL:
    - Either drop them (clean share link) OR preserve them.
    - In either case, "Copy share link" MUST copy the clean canonical form.

### C) Back/forward navigation
- Handle `popstate`:
  - When user navigates history and params change:
    - update form values
    - auto-run inspect if params valid
    - show UI error if invalid
(This is required so shared links + navigation feel consistent.)

### D) Copy share link button
- Add a button near results or near the form:
  - Label: “共有リンクをコピー” (EN will come later in i18n task)
- Copies: `${origin}${pathname}?chain=...&address=...` (canonical only)
- After copy: show small transient UI feedback (e.g. “コピーしました”)

### E) Edge cases (must handle)
- Extra whitespace in address input → trim before validation
- Missing one param (`?chain=eth`) → no auto-run + show “address required” (if params present)
- Invalid chain value → error message (allowed: eth/bsc only)
- Invalid address format → error message (0x + 40hex)

## Acceptance checklist
- [ ] Opening a shared URL auto-runs and reproduces the same inspection
- [ ] Submitting from the form updates the URL without reloading
- [ ] Refresh keeps the inspected state (from URL)
- [ ] Back/forward updates form + result appropriately
- [ ] Copy button copies canonical `?chain=&address=` and shows UI feedback
- [ ] Invalid params produce human-readable UI errors (not console-only)

## Manual verification
1) Open `/?chain=eth&address=0x...` → auto-run OK
2) Enter inputs manually → Inspect → URL updates (no reload)
3) Refresh → same state
4) Change address → Inspect → URL updates
5) Back/forward → state follows URL
6) `/?chain=eth` or `/?chain=xxx&address=...` → clear error shown

✅ タスク文ここまで

https://github.com/badjoke-lab/token-scam-inspector/pull/24

https://fc3c7a7e.token-scam-inspector.pages.dev/

---

## Task 22（改訂版）でできるようになること（完了後）

* `/api/inspect` が **常に同じ契約で** JSON を返す（成功/失敗/STALEを機械的に判定できる）
* upstream失敗時に **(1) staleがあれば stale を返す** / **(2) 無ければ ok:false** が **確実に守られる**
* **失敗理由がUIにそのまま出せる**（code + 短い日本語/英語どちらでも通る message を用意）


✅ タスク文ここから

# Task 22 — Workers: response contract (errors + stale + cache header)

## PR title rule (MUST)
PR title must start with:
- **Task 22: Stable errors + stale**

## Target (MUST: directories/files)
Cloudflare Workers only.
- `workers/src/index.*` (entry)
- `workers/src/routes/inspect.*` (inspect handler)
- `workers/src/cache/**` (cache read/write)
- `workers/src/utils/errors.*` (or equivalent)
(If actual paths differ, list the mapping in PR description. No Pages/UI changes.)

## Goal
Make `/api/inspect` behavior deterministic under failures:
- Define a stable **error taxonomy**
- Define deterministic **stale fallback**
- Add deterministic **cache status header**
No breaking changes to existing success payload.

## Source of truth (MUST FOLLOW)
- `docs/specs/spec-phase1-ja.md` (cache/stale baseline)
- `docs/specs/spec-phase2-ja.md` (error/stale/header rules)
- Ops rules: `AGENTS.md`, `codex/**`

## Hard constraints (contract)
### A) Success response (existing)
- Keep current `ok:true` response shape unchanged.

### B) Error response (when no stale can be returned)
- MUST return JSON (no HTML) with the following minimum shape:
```json
{
  "ok": false,
  "error": {
    "code": "rate_limited|missing_api_key|upstream_error|invalid_response|invalid_chain|invalid_address|missing_params",
    "message": "human-readable short message",
    "detail": { "provider": "...", "hint": "...", "status": 429 }
  },
  "meta": { "ts": "ISO8601" }
}



https://github.com/badjoke-lab/token-scam-inspector/pull/25

https://f39cf033.token-scam-inspector.pages.dev/


---

## Task 23（改訂版）でできるようになること（完了後）

* “コメント/文字列の単語一致”による誤検知が **体系的に減る**（対象チェックで共通適用）
* evidence が「何を根拠にそう言ってるか」を **短く具体的に説明**できる（検出語/検出種別/検出元）
* 以降の Task 25（ABI等でunknown減）を入れても **ノイズが爆発しない土台**ができる

```md
✅ タスク文ここから

# Task 23 — Workers: preprocessing + pattern matching contract (reduce false positives)

## PR title rule (MUST)
PR title must start with:
- **Task 23: Reduce false positives**

## Target (MUST: directories/files)
Cloudflare Workers only.
- `workers/src/checks/**` (checks that do text scanning)
- `workers/src/utils/**` (new shared helper is allowed)
- `workers/src/core/**` (only if shared in pipeline)
(If actual paths differ, list the mapping in PR description. No UI changes.)

## Goal
Introduce a shared, best-effort preprocessing + matching approach so
text-based checks do NOT trigger on trivial matches in:
- comments (`//`, `/* */`)
- string literals (`"..."`, `'...'`, template strings)
Then update relevant checks to use it and emit clearer evidence.

## Source of truth (MUST FOLLOW)
- `docs/specs/spec-phase1-ja.md` (7 checks meaning fixed)
- `docs/specs/spec-phase2-ja.md` (explainability / reduce false positives)
- Ops rules: `AGENTS.md`, `codex/**`

## Hard constraints
- No external services / no heavy parsers
- Must be safe: preprocessing MUST NOT throw on weird source; fall back to original text if needed
- No breaking response schema (only improve evidence text/fields)

## Scope (which checks MUST be updated)
Update only checks that currently rely on "source text pattern scanning".
At minimum, include any check that searches for terms like:
- blacklist / whitelisting / ban / freeze
- pause / unpause / trading enable/disable
- mint / setMinter / mintTo
If a check is ABI-only or holder-based, do NOT touch it.

## Implementation requirements
### A) Shared helper (single place)
Create a helper, e.g.
- `workers/src/utils/sourceScan.ts` (name can differ)
with:
1) `preprocessSource(text) -> { cleaned, removed }`
   - Remove comments + string literals best-effort
   - Never throw; on error return `{ cleaned: text, removed: { failed:true } }`
2) `findSignals(cleaned, patterns) -> matches[]`
   - Patterns must use boundaries / structured hints (avoid naive substring where possible)
3) `formatEvidence(matches, meta) -> string`
   - Evidence must mention:
     - what was matched (token/pattern name)
     - where it came from (sourceScan)
     - if preprocessing failed, explicitly say so

### B) Pattern rules (minimum)
- Use case-insensitive regex with word boundaries when feasible:
  - e.g. `\bblacklist\b`, `\bpause(d)?\b`, `\bmint(ing)?\b`
- Avoid matching inside longer identifiers when that would be noisy (word boundary)
- Keep a small allowlist of “strong terms” vs “weak terms”
  - weak term alone must not escalate to high (leave severity logic unchanged unless clearly broken)

### C) Evidence contract (minimum)
For any check that returns warn/high based on source scan:
- evidence MUST include at least one of:
  - `Matched: <patternName> (<regex or keyword>)`
  - `Preprocess: comments/strings removed` OR `Preprocess: failed (fallback raw)`
- If no match: evidence should NOT spam; keep short.

## Acceptance checklist
- [ ] Preprocessing does not crash on arbitrary source (fallback works)
- [ ] Comment/string-only occurrences no longer trigger (best-effort)
- [ ] At least the targeted scanning checks are using the shared helper (not copy-pasted)
- [ ] Evidence became more specific than “Found pattern”
- [ ] No response schema breaking changes

## Verification (manual)
- Add (or use existing) 2 tiny in-repo test fixtures under `workers/src/__fixtures__/` (or similar):
  1) source with `blacklist` ONLY inside a comment/string → should NOT match
  2) source with `function blacklistAddress(...)` in code → should match
- Run inspect against a known verified contract (any) and confirm:
  - evidence formatting is stable
  - no “undefined” text, no crashes

✅ タスク文ここまで

https://github.com/badjoke-lab/token-scam-inspector/pull/26

https://b93c87f3.token-scam-inspector.pages.dev/

---

## Task 24（改訂版）でできるようになること（完了後）

* `/api/inspect` に **`result.token`（name/symbol/decimals）** が **best-effortで安定追加**される
* 失敗しても **理由が説明され**、UIは「何のトークンか分からない状態」を明確に表示できる
* RPC叩きすぎで壊れないよう **キャッシュ/タイムアウト/並列制御**が入る

````md
✅ タスク文ここから

# Task 24 — Workers: token identity pipeline (ERC-20 eth_call, best-effort + cache)

## PR title rule (MUST)
PR title must start with:
- **Task 24: Token identity**

## Target (MUST: directories/files)
Cloudflare Workers only.
- `workers/src/routes/inspect.*` (attach token object to result)
- `workers/src/providers/**` (RPC client / eth_call helper)
- `workers/src/cache/**` (optional sub-cache key for token identity)
- `workers/src/utils/**` (ABI encode/decode helpers)
(If actual paths differ, list the mapping in PR description. No UI changes in this task.)

## Goal
Add minimal token identity fields to inspect response for EVM tokens:
- `result.token = { name, symbol, decimals }` (best-effort)
Optional later: `totalSupply` (NOT required in this task).

## Source of truth (MUST FOLLOW)
- `docs/specs/spec-phase2-ja.md` (allowed additive fields, free ops)
- `docs/specs/spec-phase1-ja.md` (cache/stale baseline)
- Ops rules: `AGENTS.md`, `codex/**`

## Hard constraints
- Must NOT break existing success payload (additive only)
- Must remain free-ops friendly (no paid RPC)
- Must be resilient:
  - timeouts, reverts, non-ERC20, weird encodings → no crash
  - on failure: return `result.token` as null or omit with explainable evidence

## Data + contract (MUST)
### A) Response shape (additive)
Add under `result`:
```json
"token": {
  "name": "string|null",
  "symbol": "string|null",
  "decimals": 18,
  "evidence": {
    "source": "rpc_eth_call",
    "status": "ok|partial|failed",
    "notes": "short reason if partial/failed"
  }
}
````

* `decimals` may be null if not retrievable.
* `evidence` MUST be present if `token` is present (so UI can explain).

### B) RPC method (minimum)

Use `eth_call` for ERC-20 selectors:

* `name()` → 0x06fdde03
* `symbol()` → 0x95d89b41
* `decimals()` → 0x313ce567
  (Use ABI encoding/decoding for dynamic strings; handle bytes32 fallback best-effort.)

### C) Provider selection + limits

* Use existing RPC base if present; otherwise add env var per chain:

  * `ETH_RPC_URL`, `BSC_RPC_URL` (public/free endpoints are allowed)
* Apply strict limits:

  * timeout per call (e.g. 3–5s)
  * max 3 calls total (name/symbol/decimals) with bounded concurrency (<=2)

### D) Cache strategy (must choose one)

Pick ONE and document in PR:

1. Reuse inspect cache body (token fields included in cached response), OR
2. Separate sub-key:

   * `token:{chain}:{address}` TTL 24h
     Either is fine, but must be consistent and not duplicate upstream calls unnecessarily.

### E) Failure rules (must be explicit)

* If RPC fails and inspect otherwise succeeds:

  * keep overall inspect `ok:true`
  * set token fields null/omit and mark evidence `status=failed` with reason (timeout/revert/rate_limited)
* Never turn the whole inspect into error just because token identity failed.

## Acceptance checklist

* [ ] For a well-known ERC20 on ETH, `result.token.name/symbol/decimals` are filled (best-effort)
* [ ] For a non-ERC20 contract, response still `ok:true` and token evidence explains failure
* [ ] No worker crash on malformed return data / revert
* [ ] RPC calls are bounded (timeout + limited count) and cached to avoid repeated hits
* [ ] No paid infra introduced

## Manual verification

* Test addresses:

  1. Known ERC20 (ETH) → token fields populated
  2. Random contract (non-ERC20) → token fields null + evidence failed
  3. BSC token (if RPC configured) → best-effort works or explains failure
* Confirm cache reduces repeated RPC calls (second run faster / fewer upstreams).

✅ タスク文ここまで

```
https://github.com/badjoke-lab/token-scam-inspector/pull/27

https://125e290d.token-scam-inspector.pages.dev/

---

## Task 25（改訂版）でできるようになること（完了後）

* 7チェックのうち **少なくとも3項目以上**が、よくあるトークンで **unknown→ok/warn/high** に寄りやすくなる（best-effort）
* unknown の理由が **分類されて分かる**（rate_limited / no_abi / unverified / parse_failed など）
* evidence が **「ABIで何を見た／ソースで何を見た」** を明確に示し、読める根拠になる

```md
✅ タスク文ここから

# Task 25 — Workers: reduce unknown via ABI signals + reason taxonomy (no schema break)

## PR title rule (MUST)
PR title must start with:
- **Task 25: Reduce unknown checks**

## Target (MUST: directories/files)
Cloudflare Workers only.
- `workers/src/routes/inspect.*` (wiring signals into result if needed)
- `workers/src/providers/**` (ABI fetch/parse if not already)
- `workers/src/checks/**` (apply ABI signals to relevant checks)
- `workers/src/utils/**` (shared ABI signal helpers)
(If actual paths differ, list the mapping in PR description. No UI changes.)

## Goal
Decrease "unknown" outputs by using ABI + verified-source (when available)
to produce deterministic signals for key checks, and emit clearer reasons when still unknown.

## Source of truth (MUST FOLLOW)
- `docs/specs/spec-phase1-ja.md` (7 checks meaning fixed)
- `docs/specs/spec-phase2-ja.md` (explainability, neutral language)
- Ops rules: `AGENTS.md`, `codex/**`

## Hard constraints
- Must NOT change existing response schema (text/evidence improvements allowed)
- Must remain neutral (no scam断定)
- ABI is best-effort; no heavy decompilers or paid sources

## What "unknown reduction" means (definition)
For checks that currently become `unknown` mainly due to missing verified source,
use ABI presence to output at least `warn` (or `ok`) when a relevant admin function exists (or does not),
instead of defaulting to unknown.

## Implementation requirements
### A) ABI signal extraction (shared helper)
Create a helper (single place), e.g. `utils/abiSignals.*`:
- Input: ABI JSON (array)
- Output: `signals` object with booleans + matched entries list:
  - `hasPause`, `hasUnpause`
  - `hasBlacklist`, `hasWhitelist`
  - `hasTradingEnableToggle` (enableTrading/disableTrading/openTrading/setTrading)
  - `hasMint`, `hasMinterRole` (mint, setMinter, addMinter, grantRole MINTER)
  - `hasOwnerSetter` (transferOwnership/renounceOwnership/setOwner)
- Must be resilient to ABI anomalies; never throw.

### B) Apply ABI signals to specific checks (minimum set)
Update at least these checks to use ABI signals when source scan is unavailable/weak:
1) Trading Enable Control
   - If ABI shows enable/disable/openTrading/pause → NOT unknown (warn at least)
2) Owner Privileges
   - If ABI shows ownership setters or role-granting → NOT unknown (warn)
3) Mint Capability
   - If ABI shows mint / minter role functions → NOT unknown (warn/high based on strength)
(Other checks can remain as-is if not suitable.)

### C) Strength rules (to avoid “single weak signal => high”)
Define “strong vs weak” signals for severity:
- strong signals examples:
  - `mint()` present AND `grantRole`/`setMinter` present
  - `pause()` + `unpause()` pair present
  - explicit `enableTrading`/`disableTrading` pair present
- weak signals examples:
  - only `transferOwnership` (common)
  - only generic `setConfig` without clear semantics
Rules:
- weak signal alone → max `warn`
- high requires ≥2 strong signals OR 1 strong + verified-source confirmation

### D) Evidence formatting (contract)
For any check using ABI:
- evidence MUST mention source of signal:
  - `Signal: ABI` or `Signal: VerifiedSource`
- evidence MUST list which functions triggered (short list, max 5)
Examples:
- `ABI signal: pause(), unpause() found`
- `ABI signal: mint(), setMinter() found`
If still unknown, evidence must state why:
- `Reason: no_verified_source and no_abi`
- `Reason: abi_parse_failed`
- `Reason: rate_limited (provider=...)`

### E) Unknown reason taxonomy (best-effort, text-only)
Do NOT change schema; embed reason in evidence text consistently:
- `Reason:` prefix with one of:
  - `no_abi`
  - `unverified`
  - `rate_limited`
  - `upstream_error`
  - `parse_failed`

## Acceptance checklist
- [ ] At least 3 checks (Trading/Owner/Mint) can become non-unknown based on ABI signals (best-effort)
- [ ] Evidence clearly distinguishes ABI vs source scan
- [ ] High is not produced from a single weak signal
- [ ] Unknown evidence includes a consistent `Reason:` line
- [ ] No breaking response changes; no paid infra

## Manual verification
- Test with:
  1) A verified ERC20 with ABI → see ABI evidence and fewer unknowns
  2) An unverified contract but with ABI available → ABI still reduces unknowns
  3) A contract with neither ABI nor source (or forced failure) → remains unknown with `Reason:` explained

✅ タスク文ここまで
```

https://github.com/badjoke-lab/token-scam-inspector/pull/28

https://70f0a323.token-scam-inspector.pages.dev/

---

## Task 26（改訂版）でできるようになること（完了後）

* 初心者が **「このツールは何で、何ではないか」** と **「結果の読み方」** を迷わず理解できる
* 7チェックそれぞれに **辞書ページ（意味/危険性/確認方法/よくある誤解/例）** が揃い、結果画面から即ジャンプできる
* **URLが安定**して引用・共有・SEOの土台になる（後からi18nしても崩れにくい）

```md
✅ タスク文ここから

# Task 26 — Pages: beginner guide + check dictionary (IA + templates)

## PR title rule (MUST)
PR title must start with:
- **Task 26: Guide + dictionary**

## Target (MUST: directories/files)
Cloudflare Pages frontend only.
- Add (choose ONE structure and stick to it):
  A) `app/guide/index.html` and `app/signals/**` (preferred), OR
  B) `app/guide.html` and `app/checks/**`
- Update:
  - `app/index.html` (add nav + per-check links)
  - `app/style.css` (shared styles)
  - `app/app.js` (optional: generate links dynamically if already rendering checks)
(If you choose A or B, state it in PR description and keep URLs stable.)

## Goal
Create static pages that make the product "readable" for beginners and shareable:
1) Guide page: what it is/isn't + how to read results + examples + disclaimers
2) 7 dictionary pages: one per check, using the SAME template/sections

## Source of truth (MUST FOLLOW)
- `docs/specs/spec-phase1-ja.md` (7 checks meaning fixed)
- `docs/specs/spec-phase2-ja.md` (neutral language / no scam断定)
- `docs/specs/ui-spec-ja.md` (UI wording style)
- Ops rules: `AGENTS.md`, `codex/**`

## Hard constraints
- No framework. Pure static HTML/CSS (reuse existing app styles).
- Mobile-first (360px) readable; no horizontal scroll.
- Must avoid claims of certainty: no “詐欺確定”, no investment advice.

## Information Architecture (MUST)
### A) Guide page (minimum sections)
- What this tool does (risk signals visualization)
- What it does NOT do (no scam verdict, no investment advice)
- How to read:
  - overallRisk / topReasons / checks / details / raw JSON
  - “unknown = not confirmed (not safe)”
  - “stale/cached” meaning (if present)
- Example walkthrough (1 short example)
- Safety notes + disclaimer

### B) Dictionary pages (7 pages, same template)
Each page MUST include these sections (with short, concrete text):
1) Meaning (what this check indicates)
2) Why it matters (what risk it can imply)
3) Common legit reasons (false-positive context)
4) How to verify (3–6 bullet steps; explorer/contract/tx)
5) What this tool can/can’t detect (limits)
6) Links:
   - Back to results
   - Back to guide

## URL + naming (MUST)
- Use stable slugs (ASCII recommended):
  - `sell-restriction`
  - `owner-privileges`
  - `mint-capability`
  - `liquidity-lock`
  - `holder-concentration`
  - `contract-verification`
  - `trading-control`
- Ensure main results UI links each check to its dictionary page.

## Minimal SEO/meta (MUST)
For each static page:
- `<title>` includes page name + "Token Scam Inspector"
- `<meta name="description" ...>` short (1–2 sentences)
(Do not add heavy SEO; just the basics.)

## Acceptance checklist
- [ ] Guide page exists, linked from header/nav on main
- [ ] 7 dictionary pages exist with identical section structure
- [ ] From results UI, each check has a “Learn more” link to its dictionary page
- [ ] Text is beginner-readable and neutral (no断定/投資助言)
- [ ] 360px mobile readable; no layout break

## Manual verification
- Open guide page on mobile width
- Open each dictionary page; confirm sections exist and nav works
- Run inspect; from each check row, open the corresponding dictionary page

✅ タスク文ここまで
```

https://github.com/badjoke-lab/token-scam-inspector/pull/29

https://c477e5d3.token-scam-inspector.pages.dev/

---


## Task 27（改訂版）でできるようになること（完了後）

* メインUI＋Guide＋辞書ページが **JA/ENトグル**で確実に切替できる
* 言語設定が **URL or localStorage で保持**され、再訪/共有でもブレない
* 文言追加が **辞書にキーを足すだけ**で拡張でき、ページごとに実装が分裂しない

```md
✅ タスク文ここから

# Task 27 — Pages: i18n JA/EN (dictionary + data-i18n contract)

## PR title rule (MUST)
PR title must start with:
- **Task 27: i18n JA/EN**

## Target (MUST: directories/files)
Cloudflare Pages frontend only.
- Add:
  - `app/assets/i18n.js` (preferred) OR `app/i18n.js` (choose one and standardize)
  - `app/assets/i18n/ja.js`
  - `app/assets/i18n/en.js`
- Update:
  - `app/index.html`
  - `app/app.js`
  - Guide page: `app/guide/index.html` (or `app/guide.html`)
  - Dictionary pages under `app/signals/**` (or `app/checks/**`)
  - `app/style.css` (only if needed)
(No Workers changes.)

## Goal
Implement minimal client-side i18n for visible UI strings:
- Default language: Japanese (ja)
- Toggle: JA/EN
- Applies to: main page + guide + all 7 dictionary pages
No framework, no rebuild step.

## Source of truth (MUST FOLLOW)
- `docs/specs/spec-phase2-ja.md` (i18n requirement)
- `docs/specs/ui-spec-ja.md` (wording style)
- Ops rules: `AGENTS.md`, `codex/**`

## Hard constraints (i18n contract)
### A) Markup contract
- Any translatable element MUST use:
  - `data-i18n="key"` for textContent
  - optional: `data-i18n-attr="placeholder|title|aria-label"` + `data-i18n="key"`
- Do NOT hardcode language strings in JS except fallback messages.

### B) Dictionary contract
- Keys are stable and shared across pages.
- Fallback rule:
  - if key missing in selected lang → fallback to ja → else keep original text.

### C) Language persistence (MUST)
Choose and implement BOTH:
1) URL param: `?lang=ja|en` (so shareable)
2) localStorage: `tsi_lang` (so sticky)
Priority:
- URL param > localStorage > default ja

### D) Toggle UI (MUST)
- Add a compact toggle in header (e.g. “JA / EN”)
- Switching language:
  - updates texts immediately
  - updates URL param (replaceState)
  - saves to localStorage
- Must work on mobile.

## Scope of strings (minimum)
- Main UI: labels/buttons/errors/notes ("unknown means...", "copy link", etc.)
- Guide: section titles + key paragraphs (not every long explanation if too big, but must be coherent)
- Dictionary: section headings + navigation labels at minimum
(If full body translation is too large, translate headings + key sentences first, but keep structure identical.)

## Acceptance checklist
- [ ] Toggle switches visible strings on main + guide + dictionary pages
- [ ] Default is ja; persists via localStorage
- [ ] `?lang=en` opens EN immediately (shareable)
- [ ] Missing keys fall back to ja without breaking layout
- [ ] No per-page bespoke i18n logic (all pages use same i18n.js)

## Manual verification
1) Open `/` → ja
2) Toggle EN → texts change, URL becomes `?lang=en` (or adds lang while preserving existing params)
3) Refresh → EN persists
4) Open a dictionary page with `?lang=en` → EN headings/nav
5) Remove `?lang` → follows localStorage; clear storage → default ja

✅ タスク文ここまで
```

https://github.com/badjoke-lab/token-scam-inspector/pull/30

https://70a3f867.token-scam-inspector.pages.dev/

---


## Task 28（改訂版）でできるようになること（完了後）

* Pages/Workers が壊れたときに **1コマンドで即検知**できる（戻り値でCIにも載せられる）
* `ok:false` や `rate_limited` や `STALE` が出ても **“なぜそうなったか” が表示される**
* 手元での再現が簡単（`BASE_URL` 指定、curl+jqのみ or Node1本）

```md
✅ タスク文ここから

# Task 28 — Ops: smoke script with assertions + runbook notes

## PR title rule (MUST)
PR title must start with:
- **Task 28: Smoke checks**

## Target (MUST: directories/files)
Repository root only.
- Add:
  - `scripts/smoke.sh`
- Update:
  - `README.md`
(No app/workers code changes unless absolutely required for headers already defined.)

## Goal
Provide a copy-paste runnable smoke check that:
- hits `/api/hello`
- hits `/api/inspect` for ETH and BSC sample inputs
- asserts minimum contract invariants
- exits non-zero on failure

## Source of truth (MUST FOLLOW)
- `docs/specs/spec-phase2-ja.md` (error/stale/header contract)
- Ops rules: `AGENTS.md`, `codex/**`

## Hard constraints
- Must be runnable locally without paid tools
- Must NOT print secrets
- Must have clear pass/fail output and exit codes

## Script requirements (MUST)
### A) Runtime dependencies
- Use `bash + curl` and require `jq` (common)
- If `jq` missing, print install hint and exit 2.

### B) Environment variables
- `BASE_URL` (default to production Pages URL if not set)
- `API_BASE` (optional; if set, call Workers directly)
Behavior:
- If `API_BASE` set → use it for API calls
- Else → use `${BASE_URL}/api/...` (Pages same-origin)

### C) Assertions (minimum)
1) `/api/hello`
- HTTP 200
- JSON `.ok == true`

2) `/api/inspect?chain=eth&address=...`
- HTTP 200
- JSON has `.ok` (boolean)
- If `.ok == true`:
  - has `.result.overallRisk`
  - has `.result.checks` (array length >= 7 OR object with 7 keys depending current schema)
- If `.ok == false`:
  - has `.error.code` and `.error.message`

3) Cache header contract (best-effort, do not fail hard if absent)
- Read header `x-tsi-cache`
- If present, it must be one of: HIT/MISS/STALE
- Print it.

4) Negative test (input validation)
- call `/api/inspect?chain=eth&address=0x123`:
  - Expect `.ok == false` and `.error.code` in (`invalid_address` or `missing_params`)
  - This ensures UI-level errors are not silent.

### D) Output
- Print a compact summary:
  - endpoint, status, cache header, ok/error.code
- Exit codes:
  - 0 pass
  - 1 assertion failed
  - 2 missing dependency (jq/curl)

## README requirements
Add a "Smoke check" section with:
- How to run:
  - `BASE_URL=... bash scripts/smoke.sh`
- Example for staging/dev
- If it fails: next steps bullets (check Workers deploy, env vars, upstream rate limits)

## Acceptance checklist
- [ ] `scripts/smoke.sh` exists, executable, and returns 0/1/2 appropriately
- [ ] Script validates success + error contract (not just “curl succeeded”)
- [ ] README documents usage and failure triage steps
- [ ] No secrets printed

✅ タスク文ここまで
```

https://github.com/badjoke-lab/token-scam-inspector/pull/31

https://d74acd7c.token-scam-inspector.pages.dev/





