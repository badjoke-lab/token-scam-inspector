了解。**Task 19 は「Phase 2 docs は既にある前提」で、“内容監査→漏れ補足→整合修正” のタスク**として出し直す。

---

## Task 19 でできるようになること（完了後）

* 既存の Phase 2 docs（spec/roadmap）が **要件漏れなく**揃い、以降の Task 20〜28 が **迷わず参照できる “唯一の根拠”** になる
* docs 内の **成功条件 / 非目標 / UX読み順 / エラー / キャッシュ(stale) / 共有URL / 静的ページ / i18n / smoke** が **矛盾なく**明文化される
* `docs/specs/index.md` が（存在するなら）更新され、Phase 1 / Phase 2 の参照が迷子にならない

```md
✅ タスク文ここから

# Task 19 — Phase 2 Docs: audit + patch (spec/roadmap already exists)

## PR title rule (MUST)
PR title must start with:
- **Task 19: Phase 2 docs audit+patch**

## Context
Phase 2 docs are already uploaded under `docs/` (no new creation needed by default).
This task is to REVIEW them against requirements and PATCH missing/unclear parts.

## Goal
Make Phase 2 docs complete and consistent so Tasks 20–28 can reference them without ambiguity.

## Source of truth (MUST FOLLOW)
- Phase 1 docs:
  - `docs/specs/spec-phase1-ja.md`
  - `docs/specs/roadmap-phase1-ja.md`
  - `docs/specs/task-schedule-phase1-ja.md`
  - `docs/specs/ui-spec-ja.md`
- Existing Phase 2 docs (already present in repo):
  - `docs/specs/spec-phase2-ja.md` (or equivalent)
  - `docs/specs/roadmap-phase2-ja.md` (or equivalent)
- Ops rules: `AGENTS.md`, `codex/**`, `codex/tasks/task-00-rules.md`

## Allowed changes
- Update: existing Phase 2 docs under `docs/specs/` (filenames must NOT be needlessly renamed)
- Update: `docs/specs/index.md` (IF it exists; add links)
- Must NOT break/overwrite Phase 1 docs
- Must NOT change API implementation in this task (docs-only)

## What to do (WORK ITEMS)
### 1) Inventory (must write in PR description)
- List all Phase 2 doc files found in `docs/specs/` and their roles.
- If filenames differ from the plan, keep them but note mapping:
  - spec → which file
  - roadmap → which file

### 2) Spec audit checklist (patch missing items)
Ensure `spec-phase2-ja.md` includes (or clearly references) ALL below.
If any are missing/weak, ADD/PATCH them:

A. Success conditions (minimum bar)
- “Phase 2 done” criteria in bullet form
- Explicitly: beginner-first UI order, shareable URL, human-readable errors, stale rules, fewer unknowns, guide/dictionary pages

B. Scope + Non-goals
- Scope: chains, inputs, outputs
- Non-goals: no scam断定, no investment advice, no paid infra requirement, no all-chain support

C. API response compatibility rules
- Must not break Phase 1 response shape
- Allowed additions:
  - `meta.stale` (stale return)
  - `result.token` (identity best-effort)
  - header `x-tsi-cache: HIT|MISS|STALE`

D. UX behavior requirements (beginner-first reading order)
- Order: overall/summary/topReasons → checks list → details/evidence/howToVerify → raw JSON hidden
- “unknown means not confirmed (not safe)” note
- mobile-first (360px) requirement

E. Data sources + limits
- Explorer sources, RPC best-effort for token identity
- Rate limit handling: show reasons, do not hide failures

F. Cache + stale behavior (MUST be explicit)
- TTL rules (24h baseline)
- stale return priority rules:
  - fresh success → fresh
  - upstream fail + stale exists → stale (`meta.stale=true`, header STALE)
  - upstream fail + stale none → ok:false error JSON

G. Error taxonomy (MUST be explicit)
- Define stable error codes to be used in Task 22:
  - `missing_api_key`, `rate_limited`, `upstream_error`, `invalid_response`
  - (plus input errors like invalid_chain/address)
- Must always return JSON (no HTML)

H. Explainability rules for 7 checks
- Reduce false positives (comments/strings best-effort removal) as Task 23 goal
- Evidence must state what signal was detected (not “Found pattern” only)
- Avoid single weak signal => high

I. Static pages requirements
- Guide page + 7 dictionary pages (meaning/why/howToVerify) as Task 26

J. i18n and ops verification
- Simple dictionary-based JA/EN toggle as Task 27
- Smoke check script + README ops notes as Task 28

### 3) Roadmap audit checklist (patch missing items)
Ensure `roadmap-phase2-ja.md` includes:
- Task 19–28 mapping (10 tasks) with:
  - Goal / Work items / Done criteria
- Explicit dependencies:
  - Task 19 is docs-only
  - Task 20 uses current API without changing it
  - Task 22 adds meta/header (non-breaking)
- “What is NOT included in Phase 2” note aligned with spec

### 4) Index link patch (only if file exists)
- If `docs/specs/index.md` exists:
  - Add links to Phase 2 spec/roadmap
  - Keep Phase 1 links intact

## Acceptance checklist
- [ ] Phase 2 spec/roadmap contain all required sections (no major omissions)
- [ ] Success conditions + non-goals are explicit and consistent
- [ ] Error/stale/cache rules are explicit and align with upcoming tasks
- [ ] Roadmap maps exactly Task 19–28 with Done criteria
- [ ] (If exists) specs index includes Phase 2 links
- [ ] No Phase 1 docs were modified (unless fixing a typo with explicit reason)

✅ タスク文ここまで
```

---

https://github.com/badjoke-lab/token-scam-inspector/pull/22

https://7413b3cb.token-scam-inspector.pages.dev/

---

✅ タスク文ここから

# Task 20 — UI: beginner-first result rendering (no raw JSON by default)

## PR title rule (MUST)
PR title must start with:
- **Task 20: UI readable results**

## Target (MUST: directories/files)
Cloudflare Pages frontend only.
- `app/index.html`
- `app/style.css`
- `app/app.js`
(If these do not exist, use the actual current entry files under `app/` and list the mapping in PR description. No Workers changes.)

## Goal
Replace "raw JSON dump" with an explainable, beginner-first layout:
1) Overall block (risk badge + 1–2 line summary)
2) Top reasons (3–5 bullets)
3) Checks list (7 items) as compact rows
4) Per-check details (expandable) with evidence + howToVerify
5) Raw JSON only in a collapsed `<details>` at bottom

## Source of truth (MUST FOLLOW)
- `docs/specs/ui-spec-ja.md`
- `docs/specs/spec-phase1-ja.md`
- `docs/specs/spec-phase2-ja.md` (after Task 19)
- Ops rules: `AGENTS.md`, `codex/**`

## Hard constraints
- MUST NOT change Workers/API response shape in this task
- Mobile-first: 360px width must remain readable (no horizontal scroll)

## UI requirements (minimum)
### A) States (must be visible, not console-only)
- **Empty state**: before running inspect → short guide text + example input format
- **Loading state**: spinner/text + disable submit
- **Success state**: render in the required order (below)
- **Error state** (`ok:false` or fetch fail): show human message + error code (if present)
- **Unknown guidance**: always show a note near top:
  - “unknown = 確認できなかった（安全を意味しない）”
- **Cache/stale hint** (if meta exists): show small label:
  - cached / stale (best-effort; do not depend on it)

### B) Success rendering (field mapping)
- Overall block uses:
  - `result.overallRisk` (badge)
  - `result.summary` (1–2 lines)
- Top reasons:
  - `result.topReasons[]` as bullets (max 5, safe truncation)
- Checks list (compact rows):
  - each item shows: label + status badge + short (1 line)
  - badge styles: ok / warn / high / unknown
- Per-check details (expand/collapse):
  - show **detail** (human explanation)
  - show **evidence** (what was seen / why unknown)
  - show **howToVerify** (user action steps)
  - if a field is missing, hide that section (no “undefined”)

### C) Raw JSON placement rule
- Raw JSON must be placed ONLY under:
  - `<details><summary>Raw JSON</summary> ... </details>`
- Default collapsed.

### D) Basic accessibility/UX
- Buttons have clear labels
- Expand/collapse controls are tappable on mobile
- Long strings wrap (addresses, URLs, evidence text)

## Acceptance checklist
- [ ] Default view no longer shows raw JSON
- [ ] Success UI order is exactly: Overall → Reasons → Checks → Details → Raw JSON
- [ ] Empty/Loading/Error states are visible and understandable
- [ ] Works with current `/api/inspect` response (no Workers change)
- [ ] 360px mobile layout has no horizontal scroll

## Verification (manual)
- Test with:
  1) valid ETH address
  2) invalid address (should show human error)
  3) upstream failure scenario (simulate by changing WORKERS_API_BASE temporarily) → error UI shown
- Confirm raw JSON is collapsed by default.

✅ タスク文ここまで

https://github.com/badjoke-lab/token-scam-inspector/pull/23

https://b4a2aac6.token-scam-inspector.pages.dev/

---

✅ タスク文ここから

# Task 21 — UI: shareable deep link (URL as source-of-truth)

## PR title rule (MUST)
PR title must start with:
- **Task 21: Shareable URL**

## Target (MUST: directories/files)
Cloudflare Pages frontend only.
- `app/index.html`
- `app/app.js`
- `app/style.css` (only if needed for button/layout)
(No Workers changes.)

## Goal
Make inspect state fully reproducible from URL query params:
- Canonical form: `?chain=eth&address=0x...`
When valid params exist on load, auto-run inspection.
When user runs inspection from the form, update the URL (without reload).
Provide a "Copy share link" action that copies the canonical URL.

## Source of truth (MUST FOLLOW)
- `docs/specs/spec-phase2-ja.md` (Deep link rules)
- `docs/specs/ui-spec-ja.md`
- Ops rules: `AGENTS.md`, `codex/**`

## Hard constraints
- URL is the source of truth for "what was inspected".
- MUST NOT require page reload to update URL.
- MUST show invalid-param errors in the UI (not console-only).

## Requirements (behavior)
### A) Parse on load
- On `DOMContentLoaded`:
  - read `chain`, `address` from `location.search`
  - if both valid:
    - prefill the form inputs
    - auto-trigger inspect once
  - if one is missing or invalid:
    - do NOT auto-run
    - show a human-readable error ONLY if params are present (e.g. address invalid)
      - error must say what is wrong (invalid chain / invalid address)

### B) Sync URL on submit (no reload)
- When user clicks "Inspect" and input is valid:
  - update URL via `history.replaceState` (or pushState; choose one and justify in PR)
  - canonicalize:
    - `chain` lowercased
    - `address` checksummed optional, but at least lower/trim safe
  - keep existing unrelated params OPTIONAL:
    - Either drop them (clean share link) OR preserve them.
    - In either case, "Copy share link" MUST copy the clean canonical form.

### C) Back/forward navigation
- Handle `popstate`:
  - When user navigates history and params change:
    - update form values
    - auto-run inspect if params valid
    - show UI error if invalid
(This is required so shared links + navigation feel consistent.)

### D) Copy share link button
- Add a button near results or near the form:
  - Label: “共有リンクをコピー” (EN will come later in i18n task)
- Copies: `${origin}${pathname}?chain=...&address=...` (canonical only)
- After copy: show small transient UI feedback (e.g. “コピーしました”)

### E) Edge cases (must handle)
- Extra whitespace in address input → trim before validation
- Missing one param (`?chain=eth`) → no auto-run + show “address required” (if params present)
- Invalid chain value → error message (allowed: eth/bsc only)
- Invalid address format → error message (0x + 40hex)

## Acceptance checklist
- [ ] Opening a shared URL auto-runs and reproduces the same inspection
- [ ] Submitting from the form updates the URL without reloading
- [ ] Refresh keeps the inspected state (from URL)
- [ ] Back/forward updates form + result appropriately
- [ ] Copy button copies canonical `?chain=&address=` and shows UI feedback
- [ ] Invalid params produce human-readable UI errors (not console-only)

## Manual verification
1) Open `/?chain=eth&address=0x...` → auto-run OK
2) Enter inputs manually → Inspect → URL updates (no reload)
3) Refresh → same state
4) Change address → Inspect → URL updates
5) Back/forward → state follows URL
6) `/?chain=eth` or `/?chain=xxx&address=...` → clear error shown

✅ タスク文ここまで

https://github.com/badjoke-lab/token-scam-inspector/pull/24

https://fc3c7a7e.token-scam-inspector.pages.dev/

---

https://github.com/badjoke-lab/token-scam-inspector/pull/25

https://f39cf033.token-scam-inspector.pages.dev/





